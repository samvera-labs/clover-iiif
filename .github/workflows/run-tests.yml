name: Run Tests

on:
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      NEXT_PUBLIC_BASE_PATH: /clover-iiif
      NPM_CONFIG_OPTIONAL: true

    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.9.1

      - name: Get files
        uses: actions/checkout@v3

      - name: Setup NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: Install packages (allow peer mismatch)
        run: npm ci --legacy-peer-deps

      - name: Ensure Rollup binary (Linux)
        if: runner.os == 'Linux'
        run: |
          set -e
          # Extract the rollup version from the lockfile
          ROLLUP_VERSION=$(node -p "require('./package-lock.json').packages['node_modules/rollup']?.version || ''")
          echo "Detected rollup version: ${ROLLUP_VERSION}"
          if [ -n "$ROLLUP_VERSION" ]; then
            npm i -D --no-audit --no-fund "@rollup/rollup-linux-x64-gnu@${ROLLUP_VERSION}"
          else
            echo "Rollup not found in package-lock.json; skipping explicit binary install"
          fi

      - name: Run tests
        run: npm run test:ci
